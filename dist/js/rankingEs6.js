import{genreData}from"./genreData.js";class RankingNavigation{constructor(){this.naviTabPositionArray=[],this.naviTabWidthArray=[],this.pageGenre=null,this.genreData=genreData,this.rankContentsHeightFlag=!1,this.rankContentsHeight=275,this.rankStock={action:"stockArray",genre:null,period:"daily",number:5},(this.self=this).touchstartListener=this.touchstartListener.bind(this),this.mousedownListener=this.mousedownListener.bind(this),this.touchmoveListener=this.touchmoveListener.bind(this),this.mousemoveListener=this.mousemoveListener.bind(this),this.touchendListener=this.touchendListener.bind(this),this.mouseupListener=this.mouseupListener.bind(this),this.tabNavAcion=this.tabNavAcion.bind(this)}identifyUrl(){var e=window.location.href;e.match("/movie/")?this.pageGenre="movie":e.match("/comic/")?this.pageGenre="comic":e.match("/music/")?this.pageGenre="music":e.match("/book/")?this.pageGenre="book":e.match("/motorcycle/")?this.pageGenre="motorcycle":e.match("/game/")?this.pageGenre="game":e.match("/pc/")?this.pageGenre="pc":this.pageGenre="all",this.setNavHtml()}setNavHtml(){const s=document.createElement("ul");s.classList.add("navigationWrapper");this.genreData[this.pageGenre].naviTitle.forEach((e,t)=>{var i=document.createElement("li");i.classList.add("js_tabNavigation"),i.classList.add("js_"+this.genreData[this.pageGenre].naviTitleEn[t]),i.textContent=e,s.appendChild(i)});var e=document.createElement("div"),t=(e.classList.add("spinner"),document.createElement("a")),i=(t.classList.add("toEachGenreButton"),document.createElement("div")),n=(i.classList.add("leftArrow"),document.createElement("div")),a=(n.classList.add("rightArrow"),document.querySelector("div.ranking"));a.appendChild(e),a.appendChild(t),a.appendChild(i),a.appendChild(n),document.querySelector(".rankTabArea").appendChild(s),this.switchingNavAndPage(0)}async callApi(e,t,i,s){try{document.querySelector(".rankContents").innerHTML="",document.querySelector(".spinner").style.display="block";var n=await fetch(`./js/json/${e}.json`,{method:"GET",timeout:1e4});if(!n.ok)throw new Error("HTTP error! status: "+n.status);var a=await n.json();this.setHtml(a,t,e)}catch(e){console.error("NG because: ",e),console.log("The content of the ranking has been deleted in relation to the API."),document.querySelectorAll(".rankBox").forEach(e=>e.remove())}}formatPrice(e){return e.replace(/(\d)(?=(\d{3})+$)/g,"$1,")}ellipsis(){document.querySelectorAll(".itemText").forEach(e=>{e.style.overflow="hidden",e.style.height="2.6rem",e.style.lineHeight="1.3";const t=e.innerHTML;var i=e.cloneNode(!0);for(i.style.display="none",i.style.position="absolute",i.style.backgroundColor="red",i.style.overflow="visible",i.style.width=e.offsetWidth+"px",i.style.height="auto",e.after(i);0<t.length&&i.offsetHeight>e.offsetHeight;){var s=t.slice(0,-1);i.innerHTML=s+"...",i.offsetHeight>e.offsetHeight&&(t=s)}e.innerHTML=i.innerHTML,i.remove()})}setHtml(e,t,i){(e.data||[]).forEach((e,t)=>{var i=document.createElement("span");i.classList.add("rankingMark"),i.textContent=e.rank,"1"===e.rank?i.classList.add("icon_gold"):"2"===e.rank?i.classList.add("icon_silver"):"3"===e.rank&&i.classList.add("icon_bronze");let s,n;t<3?((a=document.createElement("img")).src=e.imageUrl+"?fitin=200:200",a.alt=e.title,(s=document.createElement("div")).classList.add("itemImageWrapper"),s.appendChild(i),s.appendChild(a)):((s=document.createElement("div")).classList.add("itemImageWrapper2"),s.appendChild(i));var a=document.createElement("dd"),i=(a.classList.add("itemData__autherAndPrice"),a.innerHTML=`<span class="innerAuther">${e.author}</span><span class="innerPrice">${this.formatPrice(e.price)}円(税込)</span>`,document.createElement("dt")),r=(i.classList.add("itemText"),i.textContent=e.title,document.createElement("dt")),i=(r.classList.add("itemTextWrapper"),r.appendChild(i),document.createElement("dl")),r=(i.classList.add("itemData"),i.appendChild(r),i.appendChild(a),document.createElement("div")),a=(r.classList.add("itemDataWrap"),r.appendChild(i),(n=document.createElement("div")).classList.add("rankItem"),3<=t&&n.classList.add("itemUsuall"),n.appendChild(s),n.appendChild(r),document.createElement("div"));a.classList.add("js_itemLinkBox"),a.dataset.link=e.link,a.style.cursor="pointer",a.appendChild(n),document.querySelector(".rankContents").appendChild(a)});e="fbook"===this.pageGenre?`//suzuki/${i}/t`:`//suzuki/${i}/u`;document.querySelector(".toEachGenreButton").setAttribute("href",e),this.applyCss()}applyCss(){var e=document.querySelector(".rankContents");const t=document.querySelector(".spinner");e.animate([{opacity:"0"},{opacity:"1"}],{duration:200,fill:"forwards",easing:"ease"}).onfinish=()=>{t.style.display="none"};var i=0===this.rankContentsHeight?"28rem":this.rankContentsHeight+"px";e.style.cssText=`
      margin-top: 1.2rem;
      height: ${i};
      `,this.ellipsis(),this.attachEvents()}setNavWidthPositionArray(e){this.naviTabPositionArray=[],this.naviTabWidthArray=[];let i=0;document.querySelectorAll(".js_tabNavigation").forEach(e=>{e=e.offsetWidth;this.naviTabWidthArray.push(e+=20)}),this.naviTabWidthArray.forEach((e,t)=>{0===t?this.naviTabPositionArray.push(0):(t=t-1,i+=Number(this.naviTabWidthArray[t])+.5,this.naviTabPositionArray.push(i))}),this.setNavAttribute(e)}setNavAttribute(e){document.querySelector(`li:nth-of-type(${e+1})`).classList.add("pressed");document.querySelector(".navigationWrapper").scrollTo({left:this.naviTabPositionArray[e],behavior:"smooth"});var t=this.genreData[this.pageGenre].naviTitle.length-1,i=document.querySelector(".leftArrow"),s=document.querySelector(".rightArrow");0===e?(i.style.display="none",s.style.display="table"):e===t?(i.style.display="table",s.style.display="none"):(i.style.display="table",s.style.display="table"),this.naviTabWidthArray.forEach((e,t)=>{document.querySelector(`.js_tabNavigation:nth-of-type(${t+1})`).style.left=this.naviTabPositionArray[t]+"px"})}judgeTouchAction(e,t,i,s,n){e-=t,t=i-s;80<e?this.executePageNavDirection("right"):e<-80?this.executePageNavDirection("left"):(i=n.dataset.link)&&Math.abs(t)<5&&Math.abs(e)<5&&(location.href=i)}calcCount(e,t){return"up"==t?++e>this.genreData[this.pageGenre].naviTitle.length-1&&(e=0):--e<0&&(e=this.genreData[this.pageGenre].naviTitle.length-1),e}executePageNavDirection(e){var t,i=this.rankStock.genre;"left"==e?(t=this.calcCount(i,"down"),this.switchingNavAndPage(t),this.rankStock.genre=t):"right"==e&&(t=this.calcCount(i,"up"),this.switchingNavAndPage(t),this.rankStock.genre=t)}switchingNavAndPage(e){document.querySelectorAll(".js_tabNavigation").forEach(e=>{e.classList.remove("pressed")});const t=document.querySelector(".rankContents"),i=document.querySelector(".spinner");t.animate([{opacity:"1"},{opacity:"0"}],{duration:200,fill:"forwards",easing:"ease"}).onfinish=()=>{i.style.display="block",t.innerHTML="",this.setNavWidthPositionArray(e),this.callApi(this.genreData[this.pageGenre].genreNo[e],e,this.genreData[this.pageGenre].period,this.genreData[this.pageGenre].displayNumber),this.removeEvents()}}touchstartListener(e){e.stopPropagation(),this.startX=(this.isTouch?e.changedTouches[0]:e).pageX,this.startY=(this.isTouch?e.changedTouches[0]:e).pageY}mousedownListener(e){e.stopPropagation(),this.startX=(this.isTouch?e.changedTouches[0]:e).pageX,this.startY=(this.isTouch?e.changedTouches[0]:e).pageY}touchmoveListener(e){e.stopPropagation()}mousemoveListener(e){e.stopPropagation()}touchendListener(e){e.stopPropagation(),this.endX=(this.isTouch?e.changedTouches[0]:e).pageX,this.endY=(this.isTouch?e.changedTouches[0]:e).pageY;e=e.target;this.judgeTouchAction(this.startX,this.endX,this.startY,this.endY,e)}mouseupListener(e){e.stopPropagation(),this.endX=(this.isTouch?e.changedTouches[0]:e).pageX,this.endY=(this.isTouch?e.changedTouches[0]:e).pageY;e=e.target;this.judgeTouchAction(this.startX,this.endX,this.startY,this.endY,e)}addAllEventListener(e){this.isTouch="ontouchstart"in window,e.addEventListener("touchstart",this.touchstartListener),e.addEventListener("mousedown",this.mousedownListener),e.addEventListener("touchmove",this.touchmoveListener),e.addEventListener("mousemove",this.mousemoveListener),e.addEventListener("touchend",this.touchendListener),e.addEventListener("mouseup",this.mouseupListener)}tabNavAcion(e){e=Array.from(e.currentTarget.parentNode.children).indexOf(e.currentTarget);this.rankStock.genre=e,this.switchingNavAndPage(e)}attachEvents(){document.querySelectorAll(".js_itemLinkBox").forEach(e=>{this.addAllEventListener(e)}),document.querySelectorAll(".js_tabNavigation").forEach(e=>{e.addEventListener("click",this.tabNavAcion)})}removeAllEventListener(e){e.removeEventListener("touchstart",this.touchstartListener),e.removeEventListener("mousedown",this.mousedownListener),e.removeEventListener("touchmove",this.touchmoveListener),e.removeEventListener("mousemove",this.mousemoveListener),e.removeEventListener("touchend",this.touchendListener),e.removeEventListener("mouseup",this.mouseupListener)}removeEvents(){document.querySelectorAll(".js_itemLinkBoxAll").forEach(e=>{this.removeAllEventListener(e)}),document.querySelectorAll(".js_tabNavigation").forEach(e=>{e.removeEventListener("click",this.tabNavAcion)})}initial(){var e=this.rankStock.genre;null==e||"undefined"==e||""==e?this.identifyUrl():this.switchingNavAndPage(e)}}const rank=new RankingNavigation;window.onload=()=>{rank.initial()};